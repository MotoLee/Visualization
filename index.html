<!DOCTYPE html>
<html>
<head>
  <title></title>
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <style type="text/css">
    * {
      margin: 0;
      padding: 0;
      /*border: 1px solid;*/
    }
    .svg{
      margin: 20px;
    }

    .axis path,
    .axis line{
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
    }
    .axis text{
      font-family: sans-serif;
      font-size: 11px; 
    }
    .display_block{
      position: absolute;
      display: inline-block; 
      margin: 20px;
      height: 600px;
      width: 400px;
      padding: 0px;
      text-align: center;
    }
    .display_title{
      width: 100%;
      font: 24px sans-serif;
    }
    .display_button button{
      margin: 10px;
      border-radius: 10%;
      width: 15%;
      border: 0px;
      background-color: #A5E5F4;
    }
    #player_name #player_height{
      margin-top: 10px;
      font: 28px serif;
    }
  </style>

</head>
<body>

  <script type="text/javascript">
// TODO:
//  (1) Fix Mouseover event problem
//  (2) Add Pie chart
//  (3) Add onClick event: transfer pie chart to bar chart


    var svg_w = 600, svg_h = 600;
    var svg = d3.select("body")
      .append("svg")
      .attr("class", "svg")
      .attr("width", svg_w)
      .attr("height", svg_h);

    d3.csv("trim_baseball_data.csv", function(dataset) {

      // /** Input Data **/
      // var dataset = [
      //   {name: "Tom Brown", height: 73, weight: 170, avg:0, HR: 0},
      //   {name: "Denny Lemaster", height: 73, weight: 182, avg:0.13, HR: 4},
      //   {name: "Joe Nolan", height: 71, weight: 175, avg:0.263, HR: 27},
      //   {name: "Denny Doyle", height: 69, weight: 175, avg:0.25, HR: 16},
      //   {name: "Jose Cardenal", height: 70, weight: 150, avg:0.275, HR: 138},
      //   {name: "Mike Ryan", height: 74, weight: 205, avg:0.193, HR:28}
      //   ];

      /** Build scales: heightScale, weightScale, avgScale, hrScale **/
      var max = {height: d3.max(dataset, function(d){ return d["height"]; }),
                 weight: d3.max(dataset, function(d){ return d["weight"]; }),
                 avg: d3.max(dataset, function(d){ return d["avg"]; }),
                 hr: d3.max(dataset, function(d){ return d["HR"]; })},
          min = {height: d3.min(dataset, function(d){ return d["height"]; }),
                 weight: d3.min(dataset, function(d){ return d["weight"]; }),
                 avg: d3.min(dataset, function(d){ return d["avg"]; }),
                 hr: d3.min(dataset, function(d){ return d["HR"]; })};
          range_low = {height: Math.floor(min.height/10),
                 weight: Math.floor(min.weight/5),
                 avg: Math.floor(min.avg/0.05),
                 hr: Math.floor(min.hr/50)};
          range_high = {height: Math.ceil(max.height/10),
                 weight: Math.celi(max.weight/5),
                 avg: Math.celi(max.avg/0.05),
                 hr: Math.ceil(max.hr/50)};


      var heightScale = d3.scale.linear()
            .domain([min.height, max.height])
            .range([0.1 * svg_h, 0.85 * svg_h]),
          weightScale = d3.scale.linear()
            .domain([min.weight, max.weight])
            .range([0.1 * svg_w, 0.9 * svg_w]),
          avgScale = d3.scale.linear()
            .domain([min.avg, max.avg])
            .range([0.1 * svg_h, 0.9 * svg_h]),
          hrScale = d3.scale.linear()
            .domain([min.hr, max.hr])
            .range([0.1 * svg_w, 0.9 * svg_w]);

      // Build bins
      var height_bin = [], weight_bin = [], avg_bin = [], hr_bin = [];
      for (var i = 0; i < dataset.length; i++) {
        height_bin[(Math.floor(dataset[i]["height"]/10) - range_low.height)] = dataset[i]["height"];
        weight_bin[(Math.floor(dataset[i]["weight"]/5) - range_low.height)] = dataset[i]["weight"];
        avg_bin[(Math.floor(dataset[i]["avg"]/0.05) - range_low.avg)] = dataset[i]["avg"];
        hr_bin[(Math.floor(dataset[i]["HR"]/50) - range_low.hr)] = dataset[i]["HR"];
      }
      console.log(height_bin);
      console.log(weight_bin);
      console.log(avg_bin);
      console.log(hr_bin);


      /** Build bar chart **/
      var bar_w = svg_w / dataset.length, bar_padding = bar_w * 0.1, color = [];
      var rects = svg.append("g")
        .selectAll("rect")
        .data(dataset)
        .enter()
        .append("rect")
        .attr("id", "bar_chart")
        .attr("fill", function(d, i){
          color[i] = [Math.floor(Math.random() * 180),
                      Math.floor(Math.random() * 180),
                      Math.floor(Math.random() * 180)];
          return "rgba(" + color[i][0] + ", " + color[i][1] + ", " + color[i][2] + ", 0.8)"; 
        })
        .attr("x", function(d, i){
          return i * bar_w + (bar_padding / 2);
        })
        .attr("y", function(d){
          return 0.9 * svg_h - heightScale(d["height"]);
        })
        .attr("height", function(d){
          return heightScale(d["height"]);
        })
        .attr("width", bar_w - bar_padding);

      /** Build pie chart **/
      function buildPieChart(index){

        var pie_color = d3.scale.ordinal()
        .range(["#abc5c5","#89a68a","#6b5488","#6a456c"]);

        var dataset_HR = [], dataset_avg = []; 
        for (var i = 0; i < dataset.length; i++) {
          dataset_HR[i] = dataset[i]["HR"];
          dataset_avg[i] = dataset[i]["avg"];
        }

        var arc1 = d3.svg.arc()
        .outerRadius(100)
        .innerRadius(0);  

        var pie = d3.layout.pie()
        .sort(null) ;        

        var pie_HR = svg.append("g")
        .attr("transform", "translate(150,150)")
        .selectAll("path")
        .data(pie(dataset_HR))
        .enter()
        .append("path")
        .attr("d", arc1)
        .style("fill", function(d) {
          return pie_color(d.data);
        });

        var pie_avg = svg.append("g")
        .attr("transform", "translate(450,150)")
        .selectAll("path")
        .data(pie(dataset_avg))
        .enter()
        .append("path")
        .attr("d", arc1)
        .style("fill", function(d) {
          return color(d.data);
        });

        
      }       

      /** Add mouse events **/
      /** Event 1: Click **/
      rects.on("click", function(d, i){
        svg.selectAll("#bar_chart").remove();
        buildPieChart(i);
      });
      /** Event 2: Mouse over **/
      rects.on("mouseover", function(d, i){
        
        d3.select(this)
          .attr("fill", "rgba(" + color[i][0] + ", " + color[i][1] + ", " + color[i][2] + ", 1)")
          .attr("x", i * bar_w)
          .attr("width", bar_w)
          .attr("y", 0.9 * svg_h - (heightScale(d["height"]) * 1.1))
          .attr("height", (heightScale(d["height"]) * 1.1));

        // Add name under a bar
        svg.append("text")
           .text(d["name"])
           .attr("id","bar_label")
           .attr("x", (i + 0.5) * bar_w)
           .attr("y", 0.8 * svg_h - heightScale(d["height"]))
           .style("text-anchor", "middle")
           .attr("font-family", "sans-serif")
           .attr("font-size", "16px")
           .attr("fill", "rgba(" + color[i][0] + ", " + color[i][1] + ", " + color[i][2] + ", 1)");

        // Update player's statistic
        d3.select("#player_name").text(d["name"]);
        d3.select("#player_height").text(d["height"] + " cm / " + d["weight"] + " kg");
        d3.select("#player_avg").text("Avg: " + d["avg"]);
        d3.select("#player_hr").text("Home Run: " + d["HR"]);
      });
      /** Event 3: Mouse out **/
      rects.on("mouseout", function(d, i) { 
        d3.select(this)
          .attr("fill", "rgba(" + color[i][0] + ", " + color[i][1] + ", " + color[i][2] + ", 0.8)")
          .attr("x", (i * bar_w + (bar_padding / 2)))
          .attr("width", bar_w - bar_padding)
          .attr("y", 0.9 * svg_h - heightScale(d["height"]))
          .attr("height", heightScale(d["height"]));
        
        // Remove text label
        d3.select("#bar_label").remove();
        d3.selectAll(".player").text(" ");
      });
    
      /** Plot function for Buttons **/      
      function plot(item){
        rects.attr("y", function(d){
          if(item == "height")
            return 0.9 * svg_h - heightScale(d["height"]);
          else if(item == "weight")
            return 0.9 * svg_h - weightScale(d["weight"]);
          else if(item == "avg")
            return 0.9 * svg_h - avgScale(d["avg"]);
          else if(item == "HR")
            return 0.9 * svg_h - hrScale(d["HR"]);
        })
        .attr("height", function(d){
          if(item == "height")
            return heightScale(d["height"]);
          else if(item == "weight")
            return weightScale(d["weight"]);
          else if(item == "avg")
            return avgScale(d["avg"]);
          else if(item == "HR")
            return hrScale(d["HR"]);
          
        });  
      }


    });

    </script>

    <div class = "display_block">
      <p class = "display_title">MENU</p>
      <div class = "display_button">
        <button onclick="plot('height')">Height</button>
        <button onclick="plot('weight')">Weight</button>
        <button onclick="plot('avg')">Average</button>
        <button onclick="plot('HR')">HR</button>
      </div>
      <p class = "display_title">Player</p>
      <div class = "display_context">
        <p class = "player" id = "player_name"> </p>
        <p class = "player" id = "player_height"> </p>
        <p class = "player" id = "player_weight"> </p>
        <p class = "player" id = "player_avg"> </p>
        <p class = "player" id = "player_hr"> </p>
      </div>
    </div>
  
</body>
</html>